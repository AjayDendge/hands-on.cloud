version: 2.1
jobs:
  build:
    docker:
      - image: "cibuilds/hugo:latest"
    working_directory: /root/project
    environment:
      HUGO_HOME: /root/project/hugo
      HUGO_BUILD_DIR: /root/project/hugo/public
      HUGO_PROD_DOMAIN: "hands-on.cloud"
      HUGO_TEST_DOMAIN: "test.hands-on.cloud"
    steps:
      - run: apk update && apk add git
      - checkout
      - run: git submodule sync && git submodule update --init
      - run: apk add --update python python-dev py-pip build-base
      - run: pip install awscli
      - run: |
          cd $HUGO_HOME
          if [ "${CIRCLE_BRANCH}" = "master" ]; then
            sed -r -i.bak "s/http:\/\/localhost/https:\/\/${HUGO_PROD_DOMAIN}/g" config.toml
          else
            sed -r -i.bak "s/http:\/\/localhost/http:\/\/${HUGO_TEST_DOMAIN}/g" config.toml
          fi
          hugo -v -d $HUGO_BUILD_DIR
#      - run: |
#          htmlproofer $HUGO_BUILD_DIR --allow-hash-href --check-html \
#          --empty-alt-ignore --disable-external
      - deploy:
          name: Deploy to AWS
          command: |
            if [ "${CIRCLE_BRANCH}" = "master" ]; then
              aws s3 sync ${HUGO_BUILD_DIR} s3://origin.${HUGO_PROD_DOMAIN} --delete
              aws cloudfront create-invalidation --distribution-id=E2K9OZ801QFKCC --paths /
            else
              aws s3 sync ${HUGO_BUILD_DIR} s3://${HUGO_TEST_DOMAIN} --delete
            fi

workflows:
  version: 2
  tests:
    jobs:
      - build
